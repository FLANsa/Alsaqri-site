{% extends "base.html" %}

{% block title %}إنشاء عملية بيع جديدة{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-shopping-cart"></i> إنشاء عملية بيع جديدة</h2>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> العودة للوحة التحكم
        </a>
    </div>

    <div class="row">
        <!-- Customer Information -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user"></i> معلومات العميل</h5>
                </div>
                <div class="card-body">
                    <form id="customerForm">
                        <div class="mb-3">
                            <label for="customer_name" class="form-label">اسم العميل</label>
                            <input type="text" class="form-control" id="customer_name" name="customer_name">
                        </div>
                        <div class="mb-3">
                            <label for="customer_phone" class="form-label">رقم الهاتف</label>
                            <input type="tel" class="form-control" id="customer_phone" name="customer_phone">
                        </div>
                        <div class="mb-3">
                            <label for="customer_email" class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-control" id="customer_email" name="customer_email">
                        </div>
                        <div class="mb-3">
                            <label for="customer_address" class="form-label">العنوان</label>
                            <textarea class="form-control" id="customer_address" name="customer_address" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="payment_method" class="form-label">طريقة الدفع</label>
                            <select class="form-select" id="payment_method" name="payment_method">
                                <option value="نقدي">نقدي</option>
                                <option value="بطاقة ائتمان">بطاقة ائتمان</option>
                                <option value="تحويل بنكي">تحويل بنكي</option>
                                <option value="شيك">شيك</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">ملاحظات</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Products Selection -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-box"></i> إضافة المنتجات</h5>
                </div>
                <div class="card-body">
                    <!-- Barcode Search -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="barcode_search" class="form-label">البحث بالباركود</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="barcode_search" placeholder="أدخل الباركود للبحث عن المنتج" onkeypress="if(event.keyCode==13) searchByBarcode()">
                                <button class="btn btn-outline-primary" type="button" onclick="searchByBarcode()">
                                    <i class="fas fa-search"></i> بحث
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Product Type Selection -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="product_type" class="form-label">نوع المنتج</label>
                            <select class="form-select" id="product_type" onchange="loadProducts()">
                                <option value="">اختر نوع المنتج</option>
                                <optgroup label="الهواتف">
                                    {% for brand in phone_brands %}
                                        <option value="phone_{{ brand }}">{{ brand }}</option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="الأكسسوارات">
                                    {% for category in accessory_categories %}
                                        <option value="{{ category.name }}">{{ category.arabic_name }}</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="product_select" class="form-label">المنتج</label>
                            <select class="form-select" id="product_select" onchange="updateProductInfo()">
                                <option value="">اختر المنتج</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="quantity" class="form-label">الكمية</label>
                            <input type="number" class="form-control" id="quantity" value="1" min="1" onchange="updateTotalPrice()">
                        </div>
                    </div>

                    <!-- Product Details -->
                    <div id="product_details" class="mb-3" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>اسم المنتج:</strong> <span id="selected_product_name">-</span></p>
                                        <p><strong>الوصف:</strong> <span id="selected_product_description">-</span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="custom_price" class="form-label">السعر المخصص (شامل الضريبة)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="custom_price" step="0.01" min="0" onchange="updateTotalPrice()" oninput="updateTotalPrice()">
                                                <button class="btn btn-outline-secondary" type="button" onclick="resetToOriginalPrice()">
                                                    <i class="fas fa-undo"></i> إعادة تعيين
                                                </button>
                                            </div>
                                            <small class="text-muted">السعر الأصلي: <span id="original_price">-</span> ريال</small>
                                            <small class="text-muted d-block" id="price_difference"></small>
                                        </div>
                                        <p><strong>السعر الإجمالي (شامل الضريبة):</strong> <span id="total_price" class="text-success fw-bold">-</span> ريال</p>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="addToCart()">
                                    <i class="fas fa-plus"></i> إضافة للسلة
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Shopping Cart -->
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-shopping-cart"></i> سلة المشتريات</h6>
                        </div>
                        <div class="card-body">
                            <div id="cart_items">
                                <p class="text-muted text-center">لا توجد منتجات في السلة</p>
                            </div>
                            
                            <!-- Cart Summary -->
                            <div id="cart_summary" style="display: none;">
                                <hr>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>المجموع قبل الضريبة: <span id="cart_subtotal" class="text-primary">0.00</span> ريال</h6>
                                        <h6>مبلغ الضريبة (15%): <span id="cart_vat" class="text-warning">0.00</span> ريال</h6>
                                        <h5>المجموع الإجمالي (شامل الضريبة): <span id="cart_total" class="text-success fw-bold">0.00</span> ريال</h5>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button type="button" class="btn btn-success btn-lg" onclick="completeSale()" id="complete_sale_btn" disabled>
                                            <i class="fas fa-check"></i> إتمام عملية البيع
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let cart = [];
let products = {{ phones|tojson }};
let accessories = {{ accessories|tojson }};

function showSuccessMessage(message) {
    // Create a temporary success alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}

function searchByBarcode() {
    const barcode = document.getElementById('barcode_search').value.trim();
    if (!barcode) {
        alert('يرجى إدخال الباركود');
        return;
    }
    
    console.log('Searching for barcode:', barcode);
    console.log('Available phones:', products);
    console.log('Available accessories:', accessories);
    
    // Search in phones (exact match)
    const phone = products.find(p => p.phone_number === barcode);
    if (phone) {
        console.log('Found phone:', phone);
        // Set product type to phone brand
        document.getElementById('product_type').value = `phone_${phone.brand}`;
        loadProducts();
        
        // Find and select the phone in dropdown
        const productSelect = document.getElementById('product_select');
        for (let i = 0; i < productSelect.options.length; i++) {
            if (productSelect.options[i].value == phone.id) {
                productSelect.selectedIndex = i;
                updateProductInfo();
                // Automatically add to cart
                setTimeout(() => addToCart(), 100);
                break;
            }
        }
        return;
    }
    
    // Search in accessories (exact match)
    const accessory = accessories.find(a => a.barcode === barcode);
    if (accessory) {
        console.log('Found accessory:', accessory);
        // Determine product type based on category
        let productType = accessory.category; // Use the actual category name
        
        // Set product type
        document.getElementById('product_type').value = productType;
        loadProducts();
        
        // Find and select the accessory in dropdown
        const productSelect = document.getElementById('product_select');
        for (let i = 0; i < productSelect.options.length; i++) {
            if (productSelect.options[i].value == accessory.id) {
                productSelect.selectedIndex = i;
                updateProductInfo();
                // Automatically add to cart
                setTimeout(() => addToCart(), 100);
                break;
            }
        }
        return;
    }
    
    // Try partial search for accessories (in case barcode is truncated)
    const partialAccessory = accessories.find(a => a.barcode && a.barcode.includes(barcode));
    if (partialAccessory) {
        console.log('Found accessory (partial match):', partialAccessory);
        // Determine product type based on category
        let productType = partialAccessory.category; // Use the actual category name
        
        // Set product type
        document.getElementById('product_type').value = productType;
        loadProducts();
        
        // Find and select the accessory in dropdown
        const productSelect = document.getElementById('product_select');
        for (let i = 0; i < productSelect.options.length; i++) {
            if (productSelect.options[i].value == partialAccessory.id) {
                productSelect.selectedIndex = i;
                updateProductInfo();
                // Automatically add to cart
                setTimeout(() => addToCart(), 100);
                break;
            }
        }
        return;
    }
    
    // If not found, show detailed error
    console.log('No product found with barcode:', barcode);
    console.log('Available barcodes:');
    console.log('Phones:', products.map(p => p.phone_number));
    console.log('Accessories:', accessories.map(a => a.barcode));
    alert('لم يتم العثور على منتج بهذا الباركود: ' + barcode);
}

function loadProducts() {
    const productType = document.getElementById('product_type').value;
    const productSelect = document.getElementById('product_select');
    
    // Clear previous options
    productSelect.innerHTML = '<option value="">اختر المنتج</option>';
    
    if (productType.startsWith('phone_')) {
        // Load phones from inventory by brand
        const brand = productType.replace('phone_', '');
        products.forEach(phone => {
            if (phone.brand === brand) {
                const option = document.createElement('option');
                option.value = phone.id;
                option.textContent = `${phone.brand} ${phone.model} - ${phone.serial_number}`;
                option.setAttribute('data-price', phone.selling_price);
                option.setAttribute('data-name', `${phone.brand} ${phone.model}`);
                option.setAttribute('data-description', phone.description || '');
                productSelect.appendChild(option);
            }
        });
    } else {
        // Load accessories from inventory based on category
        accessories.forEach(accessory => {
            if (accessory.category === productType && accessory.quantity_in_stock > 0) {
                const option = document.createElement('option');
                option.value = accessory.id;
                option.textContent = `${accessory.name} (المخزون: ${accessory.quantity_in_stock})`;
                option.setAttribute('data-price', accessory.selling_price);
                option.setAttribute('data-name', accessory.name);
                option.setAttribute('data-description', accessory.description || '');
                option.setAttribute('data-stock', accessory.quantity_in_stock);
                productSelect.appendChild(option);
            }
        });
    }
}

function updateProductInfo() {
    const productSelect = document.getElementById('product_select');
    const selectedOption = productSelect.options[productSelect.selectedIndex];
    
    if (selectedOption.value) {
        const originalPrice = parseFloat(selectedOption.getAttribute('data-price'));
        
        document.getElementById('selected_product_name').textContent = selectedOption.getAttribute('data-name');
        document.getElementById('selected_product_description').textContent = selectedOption.getAttribute('data-description');
        document.getElementById('original_price').textContent = originalPrice.toFixed(2);
        
        // Set custom price to original price by default
        document.getElementById('custom_price').value = originalPrice.toFixed(2);
        
        updateTotalPrice();
        document.getElementById('product_details').style.display = 'block';
    } else {
        document.getElementById('product_details').style.display = 'none';
    }
}

function resetToOriginalPrice() {
    const originalPrice = parseFloat(document.getElementById('original_price').textContent);
    document.getElementById('custom_price').value = originalPrice.toFixed(2);
    updateTotalPrice();
}

function updateTotalPrice() {
    const price = parseFloat(document.getElementById('custom_price').value) || 0;
    const originalPrice = parseFloat(document.getElementById('original_price').textContent) || 0;
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    const total = price * quantity;
    
    // Show price difference
    const difference = price - originalPrice;
    const priceDifferenceElement = document.getElementById('price_difference');
    if (difference !== 0) {
        const differenceText = difference > 0 ? `+${difference.toFixed(2)}` : difference.toFixed(2);
        const differenceClass = difference > 0 ? 'text-danger' : 'text-success';
        priceDifferenceElement.innerHTML = `<span class="${differenceClass}">الفرق: ${differenceText} ريال</span>`;
    } else {
        priceDifferenceElement.innerHTML = '';
    }
    
    document.getElementById('total_price').textContent = total.toFixed(2);
}

function addToCart() {
    const productType = document.getElementById('product_type').value;
    const productSelect = document.getElementById('product_select');
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    const customPrice = parseFloat(document.getElementById('custom_price').value) || 0;
    
    if (!productType || !productSelect.value) {
        alert('يرجى اختيار نوع المنتج والمنتج');
        return;
    }
    
    if (customPrice <= 0) {
        alert('يرجى إدخال سعر صحيح');
        return;
    }
    
    const selectedOption = productSelect.options[productSelect.selectedIndex];
    
    // Determine the actual product type for the backend
    let actualType = productType;
    if (productType.startsWith('phone_')) {
        actualType = 'phone';
    }
    
    const product = {
        id: productSelect.value,
        type: actualType,
        name: selectedOption.getAttribute('data-name'),
        description: selectedOption.getAttribute('data-description'),
        unitPrice: customPrice,
        quantity: quantity,
        totalPrice: customPrice * quantity
    };
    
    cart.push(product);
    updateCartDisplay();
    
    // Show success message
    const successMessage = `تم إضافة ${product.name} إلى السلة بنجاح!`;
    showSuccessMessage(successMessage);
    
    // Reset form
    document.getElementById('product_type').value = '';
    document.getElementById('product_select').innerHTML = '<option value="">اختر المنتج</option>';
    document.getElementById('quantity').value = '1';
    document.getElementById('custom_price').value = '';
    document.getElementById('product_details').style.display = 'none';
    
    // Clear barcode search field
    document.getElementById('barcode_search').value = '';
}

function updateCartDisplay() {
    const cartItems = document.getElementById('cart_items');
    const cartSummary = document.getElementById('cart_summary');
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-muted text-center">لا توجد منتجات في السلة</p>';
        cartSummary.style.display = 'none';
        return;
    }
    
    let cartHTML = '<div class="table-responsive"><table class="table table-sm">';
    cartHTML += '<thead><tr><th>المنتج</th><th>السعر (شامل الضريبة)</th><th>الكمية</th><th>المجموع (شامل الضريبة)</th><th>الإجراء</th></tr></thead><tbody>';
    
    cart.forEach((item, index) => {
        cartHTML += `
            <tr>
                <td>${item.name}</td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${item.unitPrice.toFixed(2)}" 
                           step="0.01" min="0" 
                           onchange="updateCartItemPrice(${index}, this.value)"
                           style="width: 80px;">
                    ريال
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${item.quantity}" 
                           min="1" 
                           onchange="updateCartItemQuantity(${index}, this.value)"
                           style="width: 60px;">
                </td>
                <td>${item.totalPrice.toFixed(2)} ريال</td>
                <td>
                    <button class="btn btn-sm btn-warning me-1" onclick="editCartItem(${index})" title="تعديل">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})" title="حذف">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    cartHTML += '</tbody></table></div>';
    cartItems.innerHTML = cartHTML;
    
    // Update summary
    updateCartSummary();
    cartSummary.style.display = 'block';
}

function updateCartSummary() {
    const total = cart.reduce((sum, item) => sum + item.totalPrice, 0);
    // Calculate subtotal and VAT from total (since prices already include VAT)
    const subtotal = total / 1.15; // Remove VAT to get subtotal
    const vat = total - subtotal; // Calculate VAT amount
    
    document.getElementById('cart_subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('cart_vat').textContent = vat.toFixed(2);
    document.getElementById('cart_total').textContent = total.toFixed(2);
    
    // Enable complete sale button if cart has items
    document.getElementById('complete_sale_btn').disabled = cart.length === 0;
}

function updateCartItemPrice(index, newPrice) {
    const price = parseFloat(newPrice) || 0;
    if (price < 0) {
        alert('السعر يجب أن يكون أكبر من صفر');
        return;
    }
    
    cart[index].unitPrice = price;
    cart[index].totalPrice = price * cart[index].quantity;
    updateCartDisplay();
}

function updateCartItemQuantity(index, newQuantity) {
    const quantity = parseInt(newQuantity) || 1;
    if (quantity < 1) {
        alert('الكمية يجب أن تكون أكبر من صفر');
        return;
    }
    
    cart[index].quantity = quantity;
    cart[index].totalPrice = cart[index].unitPrice * quantity;
    updateCartDisplay();
}

function editCartItem(index) {
    // This function can be used for more advanced editing if needed
    // For now, the inline editing handles most cases
    alert('يمكنك تعديل السعر والكمية مباشرة في الجدول');
}

function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartDisplay();
}

function completeSale() {
    if (cart.length === 0) {
        alert('السلة فارغة');
        return;
    }
    
    // Get customer information (optional)
    const customerName = document.getElementById('customer_name').value.trim();
    const customerPhone = document.getElementById('customer_phone').value.trim();
    
    // Prepare sale data
    const saleData = {
        customer_name: customerName || 'عميل نقدي',
        customer_phone: customerPhone || '',
        customer_email: document.getElementById('customer_email').value,
        customer_address: document.getElementById('customer_address').value,
        payment_method: document.getElementById('payment_method').value,
        notes: document.getElementById('notes').value,
        items: cart
    };
    
    // Send to server
    fetch('/create_sale', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('تم إنشاء عملية البيع بنجاح!');
            window.location.href = `/sale/${data.sale_id}`;
        } else {
            alert('خطأ: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء إنشاء عملية البيع');
    });
}
</script>
{% endblock %} 